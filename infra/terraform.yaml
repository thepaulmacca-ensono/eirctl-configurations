# Terraform Tasks

tasks:
  lint:terraform:format:
    context: eir
    description: Perform Terraform Format Check
    command:
      - Invoke-Terraform -Format -Path $env:TF_FILE_LOCATION -Debug

  lint:terraform:validate:
    context: eir
    description: Perform Terraform Validation
    command:
      - Invoke-Terraform -Validate -Path $env:TF_FILE_LOCATION -Debug

  lint:terraform:tflint:
    context: eir
    description: Perform Terraform Linting using TFLint
    command:
      - |
        tflint --version
        Write-Host ("Path: {0}" -f $env:TF_FILE_LOCATION)

        tflint --init
        tflint --chdir=$env:TF_FILE_LOCATION

  terraform:init:
    context: eir
    description: Initialise Terraform
    command: |
      Invoke-Terraform -Init -Path $env:TF_FILE_LOCATION -Arguments $env:TF_BACKEND_INIT -Debug

      Invoke-Terraform -Workspace -Path $env:TF_FILE_LOCATION -Arguments $env:ENVIRONMENT_NAME -Debug

  terraform:plan:
    context: eir
    description: Terraform Plan
    command:
      - |
        $arguments = @("-input=false", "-out=`"deploy.tfplan`"")

        if ($env:WORKSPACE_VARS_FILE) {
          $arguments += "--var-file=$env:WORKSPACE_VARS_FILE"
        }

        Invoke-Terraform -Plan -Path $env:TF_FILE_LOCATION -Arguments $arguments

  terraform:apply:
    context: eir
    description: Apply Terraform Plan
    command: |
      Push-Location $env:TF_FILE_LOCATION

      Invoke-Terraform -Apply -Path deploy.tfplan -Debug

      terraform output -json | Set-Content -Path ./tfoutputs.json -Force

  terraform:destroy:plan:
    context: eir
    description: Terraform Destroy Plan
    command:
      - |
        $arguments = @("-destroy", "-input=false", "-out=`"destroy.tfplan`"")

        if ($env:WORKSPACE_VARS_FILE) {
          $arguments += "--var-file=$env:WORKSPACE_VARS_FILE"
        }

        Invoke-Terraform -Plan -Path $env:TF_FILE_LOCATION -Arguments $arguments -Debug

  terraform:destroy:apply:
    context: eir
    description: Terraform Destroy Apply
    command:
      - |
        Push-Location $env:TF_FILE_LOCATION

        Invoke-Terraform -Apply -Path destroy.tfplan -Debug

  terraform:ado:outputs:
    context: eir
    description: Get Terraform Outputs for ADO Variable Group Import
    command:
      - |
        build/powershell/Set-VariableGroupFromOutputs.ps1 `
          -organisationName $env:ADO_ORGANISATION `
          -projectName $env:ADO_PROJECT `
          -accessToken $env:ADO_ACCESS_TOKEN `
          -variableGroupName $env:ADO_VARIABLE_GROUP_NAME `
          -terraformOutputs ("{0}/tfoutputs.json" -f $env:TF_FILE_LOCATION) `
          -variableNamePrefix $env:ADO_VARIABLE_NAME_PREFIX

  doc:terraform:generate:
    context: eir
    description: Generate Terraform Module Documentation
    command:
      - |
        terraform-docs --version
        terraform-docs $env:TF_FILE_LOCATION

        git config --global --add safe.directory "/app"
        git diff --exit-code . ":(exclude)$env:TF_FILE_LOCATION/.terraform.lock.hcl"
